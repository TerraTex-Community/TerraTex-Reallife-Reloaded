local schranken = {
    { 9131, 2193.50000000, -1900.59997559, 13.80000019, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --0
    { 968, 2193.50000000, -1900.59997559, 14.10000038, 0.00000000, 270.00000000, 268.00000000, true, false, false, false, false }, --1
    { 9131, 2207.19995117, -1888.40002441, 13.19999981, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --2
    { 968, 2207.19995117, -1888.40002441, 14.00000000, 0.00000000, 270.00000000, 90.00000000, true, false, false, false, false }, --3
    { 9131, 2206.89990234, -1725.19995117, 13.00000000, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --4
    { 968, 2206.89990234, -1725.19995117, 13.90000057, 0.00000000, 270.00000000, 90.00000000, true, false, false, false, false }, --5
    { 9131, 2193.80004883, -1739.50000000, 13.10000038, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --6
    { 968, 2193.69995117, -1739.50000000, 13.99999809, 0.00000000, 90.00000000, 90.00000000, true, false, false, false, false }, --7
    { 9131, 2204.30004883, -1652.50000000, 14.89999962, 0.00000000, 0.00000000, 344.00000000, true, false, false, false, false }, --8
    { 968, 2204.19995117, -1652.50000000, 15.80000019, 0.00000000, 270.00000000, 254.00000000, true, false, false, false, false }, --9
    { 9131, 2219.60009766, -1642.09997559, 15.00000000, 0.00000000, 0.00000000, 344.00000000, true, false, false, false, false }, --10
    { 968, 2219.60009766, -1642.09997559, 15.90000057, 0.00000000, 90.00000000, 254.00000000, true, false, false, false, false }, --11
    { 9131, 1955.50000000, -1949.90002441, 13.19999981, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --12
    { 968, 1955.50000000, -1949.90002441, 14.19999981, 0.00000000, 90.00000000, 0.00000000, true, false, false, false, false }, --13
    { 9131, 1967.50000000, -1961.69995117, 13.19999981, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --14
    { 968, 1967.40002441, -1961.69995117, 14.10000038, 0.00000000, 270.00000000, 0.00000000, true, false, false, false, false }, --15
    { 9131, 2283.80004883, -1477.80004883, 22.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --16
    { 968, 2283.80004883, -1477.80004883, 23.29999924, 0.00000000, 270.00000000, 90.00000000, true, false, false, false, false }, --17
    { 9131, 2266.50000000, -1489.90002441, 22.20000076, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --18
    { 968, 2266.50000000, -1489.90002441, 23.19999886, 0.00000000, 90.00000000, 90.00000000, true, false, false, false, false }, --19
    { 9131, 2294.19995117, -1378.40002441, 23.60000038, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --20
    { 968, 2294.10009766, -1378.40002441, 24.50000000, 0.00000000, 270.00000000, 90.00000000, true, false, false, false, false }, --21
    { 9131, 2280.39990234, -1390.09997559, 23.60000038, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --22
    { 968, 2280.30004883, -1390.09997559, 24.50000000, 0.00000000, 90.00000000, 90.00000000, true, false, false, false, false }, --23
    { 9131, 2294.10009766, -1144.19995117, 26.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --24
    { 968, 2294.19995117, -1144.19995117, 27.29999924, 0.00000000, 270.00000000, 90.00000000, true, false, false, false, false }, --25
    { 9131, 2281.00000000, -1155.50000000, 26.29999924, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --26
    { 968, 2280.89990234, -1155.50000000, 27.29999924, 0.00000000, 90.00000000, 90.00000000, true, false, false, false, false }, --27
    { 9131, 2093.30004883, 2689.10009766, 10.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --28
    { 968, 2093.19995117, 2689.10009766, 11.29999924, 0.00000000, 270.00000000, 0.00000000, true, false, false, false, false }, --29
    { 9131, 2081.39990234, 2701.19995117, 10.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --30
    { 968, 2081.39990234, 2701.30004883, 11.39999962, 0.00000000, 90.00000000, 0.00000000, true, false, false, false, false }, --31
    { 9131, 1901.59997559, 2699.19995117, 10.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --32
    { 968, 1901.59997559, 2699.19995117, 11.39999962, 0.00000000, 90.00000000, 0.00000000, true, false, false, false, false }, --33
    { 9131, 1913.30004883, 2689.19995117, 10.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --34
    { 968, 1913.19995117, 2689.19995117, 11.35000038, 0.00000000, 270.00000000, 0.00000000, true, false, false, false, false }, --35
    { 9131, 1581.59997559, 2641.10009766, 10.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --36
    { 968, 1581.59997559, 2641.10009766, 11.39999962, 0.00000000, 90.00000000, 0.00000000, true, false, false, false, false }, --37
    { 9131, 1593.19995117, 2627.19995117, 10.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --38
    { 968, 1593.09997559, 2627.19995117, 11.30000019, 0.00000000, 270.00000000, 0.00000000, true, false, false, false, false }, --39
    { 9131, -1975.09997559, -573.29998779, 25.29999924, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --40
    { 968, -1975.00000000, -573.29998779, 26.29999924, 0.00000000, 90.00000000, 270.00000000, true, false, false, false, false }, --41
    { 9131, -1989.40002441, -586.59997559, 25.39999962, 0.00000000, 0.00000000, 0.00000000, true, false, false, false, false }, --42
    { 968, -1989.50000000, -586.59997559, 26.39999962, 0.00000000, 90.00000000, 90.00000000, true, false, false, false, false }
} --43

-- 9131 => Sockel  
--  968 => Schranke
-- {1-model,2-x,3-y,4-z,5-rx,6-ry,7-rz,8-status,9-inbetrieb,10-colshape,11-object,12-sockellampe}
-- status: true=zu
-- inbetrieb: true=bewegt sich
-- table:schranken
-- dis=500
local trainCoorigierungsFaktor = 0.5
local schrankenCloseDistance = 250
function onTrainSchrankeCreate()
    for theKey, theTable in ipairs(schranken) do
        local object = createObject(theTable[1], theTable[2], theTable[3], theTable[4] - trainCoorigierungsFaktor, theTable[5], theTable[6], theTable[7])
        schranken[theKey][11] = object
        object = createColCircle(theTable[2], theTable[3], schrankenCloseDistance)
        schranken[theKey][10] = object
        if (theTable[1] == 9131) then
            object = createMarker(theTable[2], theTable[3], theTable[4] + 1 - trainCoorigierungsFaktor, "corona", 2.0, 0, 0, 0, 255, getRootElement())
            schranken[theKey][12] = object
        end
    end
    setTimer(checkTrainSchrankenStatus, 1000, 0)
end
addEventHandler("onResourceStart", getResourceRootElement(getThisResource()), onTrainSchrankeCreate)

function checkTrainSchrankenStatus()
    for theKey, theTable in ipairs(schranken) do
        local elements = getElementsWithinColShape(theTable[10], "vehicle")
        local trains = 0
        for theNewKey, theVehicle in ipairs(elements) do
            if (getVehicleType(theVehicle) == "Train" or getElementModel(theVehicle) == 569 or getElementModel(theVehicle) == 570 or getElementModel(theVehicle) == 590) then
                trains = trains + 1
                if (getElementModel(theVehicle) == 569 or getElementModel(theVehicle) == 570 or getElementModel(theVehicle) == 590) then
                    --outputDebugString("Found #"..getElementModel(theVehicle))
                end
            end
        end
        if (trains > 0) then
            if (theTable[1] == 9131) then
                if (theTable[8]) then
                    schranken[theKey][8] = false
                    setMarkerColor(theTable[12], 0, 0, 0, 255)
                else
                    setMarkerColor(theTable[12], 255, 0, 0, 255)
                    schranken[theKey][8] = true
                end
            else
                if (not (theTable[9])) then
                    if not (schranken[theKey][8]) then
                        if (theTable[6] == 270) then
                            moveObject(theTable[11], 2990, theTable[2], theTable[3], theTable[4] - trainCoorigierungsFaktor, 0, -90, 0)
                        else
                            moveObject(theTable[11], 2990, theTable[2], theTable[3], theTable[4] - trainCoorigierungsFaktor, 0, 90, 0)
                        end
                        setTimer(resetTrainSchrankenStatus, 3000, 1, theKey)
                        schranken[theKey][8] = true
                        schranken[theKey][9] = true
                    end
                end
            end
        else
            if (theTable[1] == 9131) then
                schranken[theKey][8] = false
                setMarkerColor(theTable[12], 0, 0, 0, 255)
            else
                if (not (theTable[9])) then
                    if (schranken[theKey][8]) then
                        if not (theTable[6] == 270) then
                            moveObject(theTable[11], 2990, theTable[2], theTable[3], theTable[4] - trainCoorigierungsFaktor, 0, -90, 0)
                        else
                            moveObject(theTable[11], 2990, theTable[2], theTable[3], theTable[4] - trainCoorigierungsFaktor, 0, 90, 0)
                        end
                        setTimer(resetTrainSchrankenStatus, 3000, 1, theKey)
                        schranken[theKey][8] = false
                        schranken[theKey][9] = true
                    end
                end
            end
        end
    end
end

function resetTrainSchrankenStatus(key)
    schranken[key][9] = false
end
